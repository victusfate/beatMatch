<!DOCTYPE html>
<html>
<head>
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>

<meta charset="utf-8">
<style>

.chart div {
  font: 10px sans-serif;
  background-color: teal;
  text-align: right;
  padding: 3px;
  margin: 1px;
  color: white;
}

body {
  font-family: sans-serif;
}

a {
  color: #111;
  text-decoration: none;
}
</style>

<script type='text/javascript'>

    window.onload = function() {
        var allData = RESULTS.results;
        var keys = Object.keys(allData);
        var data = allData[keys[0]];

        var timer = new Date();

        var canvas0 = document.getElementById('songcanvasFile');
        var ctx0 = canvas0.getContext("2d");
        var gradient0 = ctx0.createLinearGradient(0,0,0,canvas0.height);
        gradient0.addColorStop(1,'#000000');
        gradient0.addColorStop(0.75,'#ff0000');
        gradient0.addColorStop(0.25,'#ffff00');
        gradient0.addColorStop(0,'#ffff00');

        ctx0.fillStyle = gradient0;

        function findIndex(currentTime,deltaT) {
            return parseInt(currentTime/deltaT,10);
        }

        function findMinMax(aVals) {
            var minMax = {};
            minMax.min = minMax.max = aVals[0];
            for (var i in aVals) {
                if (aVals[i] > minMax.max ) minMax.max = aVals[i];
                if (aVals[i] < minMax.min ) minMax.min = aVals[i];
            }
            return minMax;
        }


        function drawFileSpectrum() {
            var WIDTH = canvas0.width,
                HEIGHT= canvas0.height;
            // audioAnimation = requestAnimationFrame(drawSpectrum);
            setInterval(function(){
                var deltaT_ms = 0.023220 * 1000;
                var time_ms = Date.now() - timer;
                var iData = findIndex(time_ms,deltaT_ms);

                if (iData >= 0 && iData < allData.length) {
                    // console.log('iData',iData);
                    ctx0.clearRect(0, 0, WIDTH, HEIGHT);
                    data = allData[iData];
                    var minMax = findMinMax(data);
                    var min = minMax.min;
                    var max = minMax.max;
                    for ( var i = 0; i < (data.length); i++ ){
                        // var value = data[i];
                        // var value = 20 * Math.log(Math.abs(data[i]))/256;
                        // var value = (data[i]-min)/(max-min) * 256;
                        var value = 20 * Math.log(Math.abs( (data[i]-min)/(max-min) * 256 ));
                        ctx0.fillRect(i*5,HEIGHT-value,3,HEIGHT);
                    }
                }
            },75);
        }
        drawFileSpectrum();
    }

    var canvas1,ctx1,gradient1,gradient2;

    var context = new webkitAudioContext();
    var audioAnimation;
    var audioBuffer;
    var sourceNode;
    var analyser;
    var audio;

    var beatCutOff = 0;
    var onBeat = false;

    function computeBeatMatch(freqByteData) {

        var levelsCount = 8;
        var beatTime, beatLevel = 0;
        var beatHoldTime = 15; // num of frames to hold a beat
        var beatDecayRate = 0.97;
        var beatMinVol = 0.25; // a volume less than this is no beat
        var beatLevelUp = 1.05;        

        var WIDTH = canvas1.width,
            HEIGHT= canvas1.height;

        
        binCount = analyser.frequencyBinCount;
        levelBins = Math.floor(binCount / levelsCount);

        var total = 0;
        for(var i = 0; i < levelsCount; i++) {
            var totalForBin = 0;

            for(var j = 0; j < levelBins; j++) {
                totalForBin += freqByteData[(i * levelBins) + j];
            }

            var t = totalForBin / levelBins / 256;

            total += t;
        }

        var level = total / levelsCount;
        beatLevel = level;
        // console.log('beatLevel',beatLevel,'beatCutOff',beatCutOff);

        if (beatLevel > beatCutOff){
            onBeat = true;
            beatCutOff = beatLevel * beatLevelUp;
            beatTime = 0;
        } 
        else {
            if (beatTime <= beatHoldTime){
                beatTime++;
            }
            else{
                beatCutOff *= beatDecayRate;
                beatCutOff = Math.max(beatCutOff, beatMinVol);
                if (beatLevel <= beatCutOff) onBeat = false;
            }
        }        
        
    }


    function setupAudioNodes() {
      analyser = (analyser || context.createAnalyser());
      analyser.smoothingTimeConstant = 0.8;
      analyser.fftSize = 512;

      sourceNode = context.createMediaElementSource(audio);
      sourceNode.connect(analyser);
      sourceNode.connect(context.destination);
      
      audio.play();
      drawSpectrum();
    }

    function loadSong(url) {
        if (audio) audio.remove();
        if (sourceNode) sourceNode.disconnect();
        cancelAnimationFrame(audioAnimation);
        $("#playerBox").append('<audio id="player" controls="controls" src=""> </audio>');
        // $("#player").attr('src',url);
        audio = $("#player")[0];
        // audio = new Audio();
        audio.src = url;
        audio.addEventListener("canplay", function(e) {
          setupAudioNodes();
        }, false);
    }

    function drawSpectrum() {
        var WIDTH = canvas1.width,
            HEIGHT= canvas1.height,
            array =  new Uint8Array(analyser.frequencyBinCount);
        // console.log('frequency bin count',analyser.frequencyBinCount);
        analyser.getByteFrequencyData(array);
        computeBeatMatch(array);

        // console.log('onBeat',onBeat);
        if (onBeat) {
            ctx1.fillStyle = gradient2;
            // ctx1.fillRect(0,0,WIDTH,HEIGHT);
            // ctx1.fillStyle = gradient1;
        }
        else ctx1.fillStyle = gradient1;

        ctx1.clearRect(0, 0, WIDTH, HEIGHT);
        audioAnimation = requestAnimationFrame(drawSpectrum);
        for ( var i = 0; i < (array.length); i++ ){
            var value = array[i];
            ctx1.fillRect(i*5,HEIGHT-value,3,HEIGHT);
        }


    }

    $(document).ready(function(){
        // get the context from the canvas to draw on
        canvas1 = document.getElementById('songcanvas');
        ctx1 = canvas1.getContext("2d");
        gradient1 = ctx1.createLinearGradient(0,0,0,canvas1.height);
        gradient1.addColorStop(1,'#000000');
        gradient1.addColorStop(0.75,'#ff0000');
        gradient1.addColorStop(0.25,'#ffff00');
        gradient1.addColorStop(0,'#ffff00');

        gradient2 = ctx1.createLinearGradient(0,0,0,canvas1.height);
        gradient2.addColorStop(1,'#000000');
        gradient2.addColorStop(0.75,'#0000ff');
        gradient2.addColorStop(0.25,'#00ffff');
        gradient2.addColorStop(0,'#ffffff');


        ctx1.fillStyle = gradient1;


        $('.song').click(function(e){
           e.preventDefault();
           var path = $(this).attr('href');
           loadSong(path);
        });

        $("#files").on('change',function(e){
            var FileList = e.target.files,
                Reader = new FileReader();
            
            var File = FileList[0];
            loadSong(File.name);
        });

        loadSong('https://d1cmm89q88hx57.cloudfront.net/6/3/2/6325fc5bf884456afd6f543c10dc6592d3d6920a');

    });

    // $("#player").bind('canplay', function() {
    //     audio = this;
    // });    



</script>
</head>
<body>
    <canvas id="songcanvas" width="1000" height="325"></canvas>
    <form>
        <div>
            <input type = "file" id = "files" multiple />
        </div>
    </form>   
    <div id="playerBox"></div>
    <ul id="songs">
        <li><a class="song" href="https://d1cmm89q88hx57.cloudfront.net/6/3/2/6325fc5bf884456afd6f543c10dc6592d3d6920a">Friends by Tanner Walle from Bodega EP</a></li> 
        <li><a class="song" href="http://upload.wikimedia.org/wikipedia/en/4/45/ACDC_-_Back_In_Black-sample.ogg">ACDC</a></li>
        <li><a class="song" href="http://upload.wikimedia.org/wikipedia/en/9/9f/Sample_of_%22Another_Day_in_Paradise%22.ogg">Phil Collins</a></li>
        <li><a class="song" href="http://upload.wikimedia.org/wikipedia/en/1/1f/%22Layla%22%2C_Derek_and_the_Dominos_song_%28sample%29.ogg">Clapton</a></li>
    </ul>
    <canvas id="songcanvasFile" width="1000" height="325"></canvas>


</body>

<script type='text/javascript' src="spectrum.json"></script>
</html>